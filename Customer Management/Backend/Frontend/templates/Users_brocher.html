{% extends 'User_base.html' %}
{% load static %}
{% block pagetitle %}
CMS | Inventory
{% endblock %}

{% block body %}
<style>
    .modal-header,
    .modal-footer {
        border-bottom: none !important;
        border-top: none !important;
    }

    @media (max-width: 768px) {
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            display: none;
        }

        tbody tr {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            padding: 10px;
        }

        tbody td {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        tbody td:last-child {
            border-bottom: none;
        }

        tbody td::before {
            content: attr(data-label);
            font-weight: bold;
            flex: 1;
            text-align: left;
        }

        tbody td span {
            flex: 2;
            text-align: right;
        }
    }


    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
        display: block;
    }

    .table thead {
        position: sticky;
        top: 0;
        background: #021182;
        z-index: 10;
        color: #021182;
    }

       /* Full-Screen Overlay */
#overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5); /* Dark overlay with opacity */
    display: none;
    z-index: 9999; /* Ensure it appears on top */
}

/* Centered Loader */
.loader-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

</style>
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-lg-12">
            <div class="card shadow rounded">
                <div class="card-body">
                    <div class="container-fluid">
                        <div class="row align-items-center">
                            <div class="col-12 col-md-6">
                                <h4 class="text-center text-md-start">Product Brouchers</h4>
                            </div>
                            <div class="col-12 col-md-6 d-flex justify-content-center justify-content-md-end">
                                <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);"
                                    aria-label="breadcrumb">
                                    <ol class="breadcrumb mb-0">
                                        <li class="breadcrumb-item">
                                            <a href="#" class="text-decoration-none">User</a>
                                        </li>
                                        <li class="breadcrumb-item">
                                            <a href="{% url 'User_dashboard' %}" class="text-decoration-none">My
                                                Task</a>
                                        </li>
                                        <li class="breadcrumb-item">
                                            <a href="{% url 'Admin_broucher' %}" class="text-decoration-none">Product

                                            </a>
                                        </li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <div class="card shadow rounded">
                <div class="card-body">
                    {% if messages %}
                    <div class="messages-container">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="conatiner-fluid">
                        <div class="row mt-3 mb-3">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="row g-3 align-items-end">

                                    <!-- Main Category -->
                                    <div class="col-md-6 col-sm-8">
                                        <label for="category" class="pb-2">Main Category</label>
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="#" selected disabled>Choose...</option>
                                            {% for i in Catogery %}
                                            <option value="{{i.id}}">{{i.name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Subcategory (Hidden Initially) -->
                                    <div class="col-md-6 col-sm-8 d-none" id="subcategory-container">
                                        <label for="subcategory" class="pb-2">Subcategory</label>
                                        <select class="form-select" id="subcategory" name="subcategory">
                                            <option selected disabled>Choose...</option>
                                        </select>
                                    </div>

                                    <!-- Filter & Reset Buttons -->
                                    <div class="col-md-4 col-sm-6">
                                        <button class="btn w-100" id="filter_btn" onclick="Filter()"
                                            style="background-color: #021182; color:white">
                                            <i class="fa-solid fa-filter"></i> Filter
                                        </button>
                                    </div>
                                    <div class="col-md-4 col-sm-6">
                                        <button class="btn w-100" id="reset_btn" onclick="reset()"
                                            style="background-color: rgb(128, 2, 2); color:white">
                                            <i class="fa-solid fa-filter-circle-xmark"></i> Reset
                                        </button>
                                    </div>

                                </div>
                            </div>



                            <div
                                class="col-lg-6 col-md-6 col-sm-12 mt-3 mt-md-0 d-flex justify-content-lg-end justify-content-md-end justify-content-center gap-2">

                                <!-- Categories Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-sm dropdown-toggle d-flex align-items-center"
                                        style="background-color: #021182; color:white; height:40px;" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fa-solid fa-layer-group me-2"></i>Categories
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item fw-medium" data-bs-toggle="modal"
                                                data-bs-target="#Add_Catogery" href="#">Main Category</a></li>
                                        <li><a class="dropdown-item fw-medium" data-bs-toggle="modal"
                                                data-bs-target="#addSubcategoryModal" href="#">Sub Category</a></li>
                                        <li><a class="dropdown-item fw-medium" data-bs-toggle="modal"
                                                data-bs-target="#List_category" href="#">List Category</a></li>
                                        <li><a class="dropdown-item fw-medium"  data-bs-toggle="modal" data-bs-target="#D_Broucher"
                                             href="#">Download Brochure</a></li>
                                    </ul>
                                </div>
                                <!-- data-bs-toggle="modal" data-bs-target="#D_Brochure" -->
                                <!-- Add Product Button -->
                                <button class="btn btn-sm d-flex align-items-center" data-bs-toggle="modal"
                                    data-bs-target="#Add_product"
                                    style="background-color: #021182; color:white; height:40px;">
                                    <i class="fa-solid fa-cubes me-2"></i> Add Product
                                </button>

                                <!-- Download Broucher Button -->
                                <!-- <a href="#" class="btn btn-sm d-flex align-items-center"
                                    style="background-color: #198754; color:white; height:40px;">
                                    <i class="fa-solid fa-download me-2"></i>Broucher Filters
                                </a> -->

                            </div>


                        </div>

                    </div>

                    <div class="mt-5">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">

                            <table class="table table-hover mt-5">
                                <thead>
                                    <tr>
                                        <th class="pb-4">Product Code</th>
                                        <th class="pb-4 ">Product Name</th>
                                        <th class="pb-4">Image</th>
                                        <th class="pb-4">Category</th>
                                        <th class="pb-4">Stock</th>
                                        <th class="pb-4">Retail Price</th>
                                        <th class="pb-4">Wholesale Price</th>
                                        <th class="pb-4">Re-seller Price</th>
                                        <th class="pb-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="Table_data">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Add Catogery -->
<div class="modal fade" id="Add_Catogery" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Create Catogery</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/create_catogery/" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 pt-2">
                            <label for="Catogery_name" class="form-label fw-medium pb-2">Catogery Name</label>
                            <input type="text" class="form-control" id="Catogery_name" name="Catogery_name">
                        </div>
                    </div>
                    <div class="modal-footer mt-3">
                        <button type="submit" class="btn " onclick=""
                            style="background-color:  #021182;color:white">Save Category</button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>
<!-- End Of Catogery -->


<!-- Add product -->

<div class="modal fade" id="Add_product" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Add product</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" action="/add_product/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row g-3">
                        <!-- Product Name -->
                        <div class="col-md-6">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" name="name" required
                                placeholder="Product Name">
                        </div>

                        <!-- Category -->
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="AddPcategory" name="AddPcategory" required>
                                <option selected disabled>Choose...</option>

                                {% for i in Catogery %}
                                <option value="{{i.id}}">{{i.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Stock -->
                        <div class="col-md-6">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0" required
                                placeholder="Stock">
                        </div>

                        <!-- Image Upload -->
                        <div class="col-md-6">
                            <label for="productImage" class="form-label">Product Image</label>
                            <input type="file" class="form-control" id="productImage" name="image" accept="image/*"
                                multiple>
                        </div>
                        <div class="col-md-6 mt-2">
                            <label for="subcategory" class="pb-2">Subcategory</label>
                            <select class="form-select" id="subcategory1" name="subcategory1">
                                <option selected disabled>Choose...</option>

                            </select>
                        </div>
                        <div class="col-md-6 mt-2">
                            <label for="Retail_P" class="form-label">Retail Price</label>
                            <input type="number" class="form-control" id="Retail_P" name="Retail_P" min="0" required
                                placeholder="Retail Price">
                        </div>
                        <div class="col-md-6">
                            <label for="Re_seller_P" class="form-label">Re-seller Price</label>
                            <input type="number" class="form-control" id="Re_seller_P" name="Re_seller_P" min="0"
                                required placeholder="Reseller Price">
                        </div>
                        <div class="col-md-6">
                            <label for="Wholesale_P" class="form-label">Wholesale Price</label>
                            <input type="number" class="form-control" id="Wholesale_P" name="Wholesale_P" min="0"
                                required placeholder="Wholesale Price">
                        </div>



                    </div>
                    <!-- Description -->
                    <div class="col-md-12 pt-4">
                        <label for="description" class="form-label">Product Description</label>
                        <textarea class="form-control" id="Adddescription" name="Adddescription" rows="3"
                            placeholder="Product Description"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="Reset" class="btn btn-primary">Reset</button>
                        <button type="submit" class="btn btn-primary">Save</button>

                    </div>
                </form>
            </div>

        </div>
    </div>
</div>



<!-- End Of Add product -->

<!-- SubCategory -->
<div class="modal fade" id="addSubcategoryModal" aria-labelledby="addSubcategoryLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubcategoryLabel">Add Subcategory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm" action="/pOst_sub_cat/" method="post">
                    {% csrf_token %}
                    <!-- Select Main Category -->
                    <div class="mb-3">
                        <label for="mainCategory" class="form-label">Main Category</label>
                        <select class="form-select" id="main_category" name="main_category" required>
                            <option selected disabled>Choose...</option>

                            {% for i in Catogery %}
                            <option value="{{i.id}}">{{i.name}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Subcategory Name -->
                    <div class="mb-3">
                        <label for="subcategoryName" class="form-label">Subcategory Name</label>
                        <input type="text" class="form-control" id="subcategoryName" name="subcategory_name" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn" style="background-color:  #021182;color:white">Save
                        Subcategory</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- END SubCategory -->


<!-- category List -->
<div class="modal fade" id="List_category" aria-labelledby="addSubcategoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubcategoryLabel">Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <h3 class="mb-4">Main Categories & Subcategories</h3>

                    <div class="accordion" id="categoryAccordion">
                        {% for category in categories %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ category.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ category.id }}" aria-expanded="false"
                                    aria-controls="collapse{{ category.id }}">
                                    {{ category.name }}
                                </button>
                            </h2>
                            <div id="collapse{{ category.id }}" class="accordion-collapse collapse"
                                aria-labelledby="heading{{ category.id }}" data-bs-parent="#categoryAccordion">
                                <div class="accordion-body">
                                    <ul class="list-group">
                                        {% if category.subcategories %}
                                        {% for sub in category.subcategories %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center" id="subcategory-{{ sub.id }}">
                                            {{ sub.name }}
                                            <span>
                                                <a href="#" onclick="deletes('{{ sub.id }}')">
                                                    <i class="fa-solid fa-trash"></i> Delete
                                                </a>
                                            </span>
                                        </li>
                                        {% endfor %}
                                        {% else %}
                                        <li class="list-group-item text-muted">No subcategories available!</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>

<!-- END category List -->

<!-- Update stock -->


<div class="modal" tabindex="-1" id="Update_stock" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="#" method="POST">
                    <input type="hidden" id="done_csrf" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <input type="hidden" name="hiddengem" id="hiddengem">

                    <div class="row">
                        <h2 class="mb-3">Stock</h2>
                        <div class="mb-3">
                            <label class="form-label" for="Stock_count">Stock</label>
                            <input class="form-control" type="number" name="Stock_count" id="Stock_count" min="0"
                                required>
                        </div>

                        <hr class="mt-4">

                        <h2 class="mt-3 mb-3">Price</h2>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="Update_Retail_P" class="form-label">Retail Price</label>
                                <input type="number" class="form-control" id="Update_Retail_P" name="Update_Retail_P"
                                    min="0" required placeholder="Retail Price">
                            </div>
                            <div class="col-md-4">
                                <label for="Update_Re_seller_P" class="form-label">Re-seller Price</label>
                                <input type="number" class="form-control" id="Update_Re_seller_P"
                                    name="Update_Re_seller_P" min="0" required placeholder="Reseller Price">
                            </div>
                            <div class="col-md-4">
                                <label for="Update_Wholesale_P" class="form-label">Wholesale Price</label>
                                <input type="number" class="form-control" id="Update_Wholesale_P"
                                    name="Update_Wholesale_P" min="0" required placeholder="Wholesale Price">
                            </div>
                        </div>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="updatestock()">Save changes</button>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="Delete_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="">
                    <input type="hidden" name="IDs" id="IDs" hidden>
                    <input type="text" value="{{ csrf_token }}" name="delete_CSRF" id="delete_CSRF" hidden>

                    <div class="text-center mt-3">
                        <i class="fa-solid fa-triangle-exclamation fs-1 text-danger"></i>
                    </div>
                    <div class="text-center mt-2">
                        <p class="fw-medium">Do want to detete the Product ?<br>once deteted not able to recover</p>
                    </div>
                    <div class="text-center mt-4 rounded-xl">
                        <button type="button" class="btn btn-danger" onclick="Product_detele()">Confirm</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- D_Broucher-->

<div class="modal fade" id="D_Broucher" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Broucher Filter <i class="fa-solid fa-filter"></i>
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <form action="#">
                                <div class="row ">

                                    <input type="text" name="DB_CSRF" id="DB_CSRF" value="{{ csrf_token }}" hidden>
                                    <div class="col-md-3 col-sm-8">
                                        <label for="category" class="pb-2">Main Category</label>
                                        <select class="form-select" id="D_Broucher_category" name="D_Broucher_category"
                                            required>
                                            <option value="#" selected disabled>Choose...</option>
                                            {% for i in Catogery %}
                                            <option value="{{i.id}}">{{i.name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-3 col-sm-8" id="D_Broucher_subcategory-container">
                                        <label for="subcategory" class="pb-2">Subcategory</label>
                                        <select class="form-select" id="D_Broucher_subcategory"
                                            name="D_Broucher_subcategory">
                                            <option selected disabled>Choose...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 col-sm-8" id="D_Broucher_subcategory-container">
                                        <label for="Price_category" class="pb-2">Buyer Type</label>
                                        <select class="form-select" id="Price_category" name="Price_category">
                                            <option  disabled>Choose...</option>
                                            <option value="Retail_Price" selected>Retail</option>
                                            <option value="Re_seller_Price">Re-seller</option>
                                            <option value="Wholesale_Price">Wholesaler</option>
                                        </select>
                                    </div>
                                    <div id="overlay">
                                        <div class="loader-container">
                                            <div class="spinner-border text-light" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-8">
                                        <label for="priceRange" class="form-label">Select Price Range:</label>
                                        <input type="number" class="form-control" id="priceRange">

                                    </div>
                                    <div class="col-md-3 col-sm-8 pt-3">
                                        <label for="Minimum_stock" class="form-label">Minimum stock:</label>
                                        <input type="number" class="form-control" id="Minimum_stock" name="Minimum_stock">

                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn " style="background-color: #021182; color:white"
                    id="downloadBrochureBtn">Download Broucher</button>
            </div>
        </div>
    </div>
</div>

<!-- D_Broucher-->


<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="{% static 'Js/D_broucher.js' %}"></script>
<script>

    $(document).ready(function () {
        $(".alert").each(function () {
            var $alert = $(this);
            $alert.addClass("show");

            setTimeout(function () {
                $alert.addClass("hide");
            }, 3000);
        });
    });


    const supplier = () => {
        $.ajax({
            url: "/add_product/",
            method: "GET",
            contentType: "json",
            success: function (response) {
                $("#Table_data").empty();
            
                if (response.Products.length === 0) {
                    $("#Table_data").append(`
                        <tr>
                            <td colspan="9" class="text-center text-muted">No Product available!</td>
                        </tr>
                    `);
                } else {
                    $.each(response.Products, function (index, item) {
                        let actions = `
                            <div class="dropdown">
                                <a href="#" class="text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item edit-btn" href="#" data-bs-toggle="modal"
                                            data-bs-target="#Edit_Customers" onclick="Getstock(${item.id})" 
                                            id="edit-${item.id}">Update Stock</a>
                                    </li>
                        `;
            
                        // Add delete option only for `superadmin`
                        if (response.role === "superadmin") {
                            actions += `
                                <li>
                                    <a class="dropdown-item" onclick="Delete_Customer(${item.id})" 
                                        href="#" id="${item.id}">Delete</a>
                                </li>
                            `;
                        }
            
                        actions += `</ul></div>`;
            
                        // Handle multiple images - Display the first image or a placeholder if no images exist
                        let imageDisplay = `<img src="/static/images/no-image.png" style="height:40px; width:40px;"/>`; // Default image
                        if (item.images.length > 0) {
                            imageDisplay = `<img src="${item.images[0]}" style="height:40px; width:40px;"/>`; // Show first image
                        }
            
                        // Append row
                        $("#Table_data").append(`
                            <tr>
                                <td data-label="Product ID" class="pt-4 pb-4" style="color: red;font-weight:600;">${item.product_id}</td>
                                <td data-label="Product Name" class="pt-4 pb-4">${item.name}</td>
                                <td data-label="Image" class="pt-4 pb-4">${imageDisplay}</td>
                                <td data-label="Category" class="pt-4 pb-4"><span class="badge text-bg-warning">${item.category__name}</span></td>
                                <td data-label="Stock" class="pt-4 pb-4 fw-bolder">${item.stock}</td>
                                <td data-label="Retail Price" class="pt-4 pb-4 fw-bolder">${item.Retail_Price}</td>
                                <td data-label="Wholesale Price" class="pt-4 pb-4 fw-bolder">${item.Wholesale_Price}</td>
                                <td data-label="Reseller Price" class="pt-4 pb-4 fw-bolder">${item.Re_seller_Price}</td>
                                <td data-label="Actions" class="pt-4 pb-4">${actions}</td>
                            </tr>
                        `);
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }


        })
    }

    $(document).ready(function () {
        supplier()
    })
    //.................................................. Cat data filter ...............................................................


    const Filter = () => {
        let main = $("#category").val()
        let sub = $("#subcategory").val()
        console.log(main + sub)
        let urls = sub ? `/Multi_filter/${main}/${sub}/` : `/Multi_filter/${main}/`;

        $.ajax({
            url: urls,
            method: "GET",
            contentType: "json",
            success: function (response) {
                $("#Table_data").empty();
            
                if (response.products.length === 0) {  // Fixed from response.Products (capital P)
                    $("#Table_data").append(`
                        <tr>
                            <td colspan="9" class="text-center text-muted">No Product available!</td>
                        </tr>
                    `);
                } else {
                    $.each(response.products, function (index, item) {  // Fixed from response.Products
                        let actions = `
                            <div class="dropdown">
                                <a href="#" class="text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item edit-btn" href="#" data-bs-toggle="modal"
                                            data-bs-target="#Edit_Customers" onclick="Getstock(${item.id})" 
                                            id="edit-${item.id}">Update Stock</a>
                                    </li>
                        `;
            
                        // Add delete option only for `superadmin`
                        if (response.role === "superadmin") {
                            actions += `
                                <li>
                                    <a class="dropdown-item" onclick="Delete_Customer(${item.id})" 
                                        href="#" id="${item.id}">Delete</a>
                                </li>
                            `;
                        }
            
                        actions += `</ul></div>`;
            
                        // Handle multiple images - Display the first image or a placeholder if no images exist
                        let imageDisplay = `<img src="/static/images/no-image.png" style="height:40px; width:40px;"/>`; // Default image
                        if (item.images.length > 0) {
                            imageDisplay = `<img src="${item.images[0]}" style="height:40px; width:40px; object-fit:cover; border-radius:5px;"/>`; // Show first image
                        }
            
                        // Append row
                        $("#Table_data").append(`
                            <tr>
                                <td data-label="Product ID" class="pt-4 pb-4" style="color: red;font-weight:600;">${item.product_id}</td>
                                <td data-label="Product Name" class="pt-4 pb-4">${item.name}</td>
                                <td data-label="Image" class="pt-4 pb-4">${imageDisplay}</td>
                                <td data-label="Category" class="pt-4 pb-4"><span class="badge text-bg-warning">${item.category__name}</span></td>
                                <td data-label="Stock" class="pt-4 pb-4 fw-bolder">${item.stock}</td>
                                <td data-label="Retail Price" class="pt-4 pb-4 fw-bolder">${item.Retail_Price}</td>
                                <td data-label="Wholesale Price" class="pt-4 pb-4 fw-bolder">${item.Wholesale_Price}</td>
                                <td data-label="Reseller Price" class="pt-4 pb-4 fw-bolder">${item.Re_seller_Price}</td>
                                <td data-label="Actions" class="pt-4 pb-4">${actions}</td>
                            </tr>
                        `);
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }


        })
    }



    // ..................................................category  filter ................................................................
    $("#category").change(function () {
        var categoryId = $(this).val();
        var subcategoryDropdown = $("#subcategory");
        var subcategoryContainer = $("#subcategory-container");

        console.log("Selected Category ID:", categoryId); // Debugging

        if (categoryId) {
            $.ajax({
                url: `/gEt_sub_cat/${categoryId}/`, // Ensure correct URL format
                type: "GET",
                success: function (data) {
                    console.log("AJAX Response:", data); // Log full response

                    subcategoryDropdown.empty().append('<option selected disabled>Choose...</option>');

                    if (data.sub && data.sub.length > 0) {
                        subcategoryContainer.removeClass("d-none"); // Show subcategory dropdown
                        $.each(data.sub, function (index, sub) {
                            console.log("Appending subcategory:", sub.name); // Debug log
                            subcategoryDropdown.append(`<option value="${sub.id}">${sub.name}</option>`);
                        });
                    } else {
                        console.log("No subcategories found!");
                        subcategoryContainer.addClass("d-none"); // Hide if no subcategories
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error fetching subcategories:", error);
                    alert("Error fetching subcategories! Check console for details.");
                }
            });
        } else {
            subcategoryContainer.addClass("d-none"); // Hide if no category is selected
        }
    });



    $("#AddPcategory").change(function () {
        var categoryId = $(this).val();
        var subcategoryDropdown = $("#subcategory1");

        console.log("Category Selected:", categoryId);

        subcategoryDropdown.empty().append('<option selected disabled>Loading...</option>');

        if (categoryId) {
            $.ajax({
                url: `/gEt_sub_cat/${categoryId}/`,
                type: "GET",
                success: function (data) {
                    console.log("AJAX Response:", data);
                    subcategoryDropdown.empty().append('<option selected disabled>Choose...</option>');

                    if (data.sub && data.sub.length > 0) {
                        $.each(data.sub, function (index, sub) {
                            subcategoryDropdown.append(`<option value="${sub.id}">${sub.name}</option>`);
                        });
                    } else {
                        console.log("No subcategories found.");
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error fetching subcategories:", error);
                }
            });
        }
    });


    const reset = () => {
        supplier()
        $("#subcategory-container").addClass("d-none");
        $("#category").val("#")
    }

    const Getstock = (id) => {

        console.log('{"id":' + id)
        $.ajax({
            url: "/Edit_product/" + id,
            type: "GET",
            contentType: "json",

            success: function (data) {
                console.log(data)
                $.each(data.product, function (index, sub) {
                    $("#Stock_count").val(sub.stock)
                    $("#Update_Retail_P").val(sub.Retail_Price)
                    $("#Update_Re_seller_P").val(sub.Re_seller_Price)
                    $("#Update_Wholesale_P").val(sub.Wholesale_Price)
                })
                $("#Update_stock").attr("aria-hidden", "false")
                    .modal("show")
                    .focus();
                $("#hiddengem").val(id)
            },
            error: function () {
                alert("Error fetching subcategories!");
            }



        })
    }

    const updatestock = () => {
        var id = $("#hiddengem").val()
        var csrf = $("#done_csrf").val()
        var setof = {
            stock: $("#Stock_count").val(),
            Retail: $("#Update_Retail_P").val(),
            Re_sellers: $("#Update_Re_seller_P").val(),
            Wholesellers: $("#Update_Wholesale_P").val()

        }
        console.log(setof)
        $.ajax({
            url: "/Edit_product/" + id,
            type: "POST",
            contentType: "json",
            headers: {
                "X-CSRFToken": csrf
            },
            data: JSON.stringify(setof),
            success: function () {
                alert("Stock Update successfully !")
                window.location.reload()
            },
            error: function () {
                alert("Error ");
            }

        })
    }

    function Delete_Customer(id) {
        $('#Delete_modal').modal('show')
        console.log(id)
        $("#IDs").val(id)


    }

    const Product_detele = () => {
        let id = $("#IDs").val()
        let csrfToken = $("#delete_CSRF").val();
        $.ajax({
            url: "/product_customer/" + id + "/",
            type: "DELETE",
            headers: {
                "X-CSRFToken": csrfToken
            },
            success: function () {
                location.reload()
            },
            error: function (xhr, status, error) {
                console.log("Error:", xhr.responseText);
                alert("Detele failed!");
            }
        })
    }

    $(document).ready(function () {
        $("#downloadBrochureBtn").click(function (e) {
            e.preventDefault();
    
            let category = $("#D_Broucher_category").val();
            let subcategory = $("#D_Broucher_subcategory").val();
            let buyerType = $("#Price_category").val();
            let priceRange = $("#priceRange").val() || null;  // Convert empty string to null
            let csrf = $("#DB_CSRF").val();
            let Minimum_stock = $("#Minimum_stock").val() || null
            if (!category || !buyerType) {
                alert("Please fill in all required fields.");
                return;
            }
    
            let requestData = {
                category: category,
                subcategory: subcategory || null,
                buyer_type: buyerType,
                price_range: priceRange,
                Minimum_stock :Minimum_stock || null
            };
    
            // Show overlay & disable button
            $("#overlay").fadeIn();
            $("#downloadBrochureBtn").prop("disabled", true);
    
            $.ajax({
                url: `/download-brochure/`,
                type: "POST",
                data: JSON.stringify(requestData),
                contentType: "application/json",
                headers: { "X-CSRFToken": csrf },
                xhrFields: { responseType: "blob" }, // Ensure the response is treated as a binary blob
                success: function (data) {
                    console.log(csrf)
                    let blob = new Blob([data], { type: "application/pdf" });
                    let url = window.URL.createObjectURL(blob);
                    let a = document.createElement("a");
                    a.href = url;
                    a.download = "Brochure.pdf";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url); // Free up memory
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                    alert("Failed to download brochure.");
                },
                complete: function () {
                    // Hide overlay & enable button after request completes
                    $("#overlay").fadeOut();
                    $("#downloadBrochureBtn").prop("disabled", false);
                }
            });
        });
    });
    


    function deletes(subcategoryId) {
        if (confirm("Are you sure you want to delete this subcategory?")) {
            $.ajax({
                url: `/Delete_SubCato/${subcategoryId}/`,
                type: "DELETE",
                headers: { "X-CSRFToken": getCSRFToken() }, // Include CSRF token
                success: function (response) {
                    window.location.reload()
                },
                error: function (xhr) {
                   console.log("Error")
                }
            });
        }
    }
    
    // Function to fetch CSRF token
    function getCSRFToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

</script>

{% endblock %}